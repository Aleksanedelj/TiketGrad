@using WebApplication4.Models

@model WebApplication4.Helper_Code.ViewModels.TicketImgVM

@{
    ViewBag.Title = "Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script src="~/Scripts/jquery-3.7.1.js" type="text/javascript"></script>
<!--font awesome javascript-->
<script src="https://kit.fontawesome.com/c4a0283025.js" crossorigin="anonymous"></script>
<!--tinyMCE javascript-->
<script src="https://cdn.tiny.cloud/1/tzs8al0oog6wu0wnz79fc7pe8acr88begp1r2qfpdi9u3nju/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

<script>
    tinymce.init({
        selector: '#idTekst'
    });
</script>

<div class="container col-lg-12">
    <div class="row justify-content-center">
        <div class="col-lg-12">

            @{
                if (TempData["MessageErrorTicket"] != null)
                {
                    <div class="alert alert-secondary" style="text-align:center;">
                        <strong>@TempData["MessageErrorTicket"]</strong>
                    </div>
                }
            }

            @{
                if (TempData["MessageSuccessTicket"] != null)
                {
                    <div class="alert alert-success" style="text-align:center;">
                        <strong>@TempData["MessageSuccessTicket"]</strong>
                    </div>
                }
            }

            <div class="card o-hidden border-0 shadow-lg my-5">
                <div class="card-body p-0">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="p-5">
                                <h2 style="text-align: center; font-weight:bold;">Pregled tiketa - @Model.Tiketi.IDTiket</h2> <br />

                                <ul class="nav nav-tabs" id="myTab" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Osnovni podaci</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">
                                            Komentari
                                            @{
                                                var brojacKom = 0;

                                                foreach (var item in Model.Tiketi.Komentars)
                                                {
                                                    if (item.Datum.Value.Date == DateTime.Now.Date)
                                                    {
                                                        brojacKom++;
                                                    }
                                                }

                                                if (@brojacKom > 0)
                                                {
                                                    <span class="badge text-bg-secondary">@brojacKom</span>
                                                }

                                            }
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="contact-tab" data-toggle="tab" href="#contact" role="tab" aria-controls="contact" aria-selected="false">
                                            Dokumenta
                                            @{
                                                var brojacFiles = 0;

                                                foreach (var item in Model.Tiketi.tbl_file)
                                                {
                                                    if (item.Datum.Value.Date == DateTime.Now.Date)
                                                    {
                                                        brojacFiles++;
                                                    }
                                                }

                                                if (@brojacFiles > 0)
                                                {
                                                    <span class="badge text-bg-secondary">@brojacFiles</span>
                                                }

                                            }
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="contact1-tab" data-toggle="tab" href="#contact1" role="tab" aria-controls="contact1" aria-selected="false">Izmena detalja tiketa</a>
                                    </li>
                                </ul>



                                <div class="tab-content" id="myTabContent">
                                    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">

                                        <br />

                                        <table @*class="table"*@ class="table table-bordered table-striped" style="table-layout:fixed;">
                                            <thead>
                                                <tr style="text-align:center; font-size:18px;">
                                                    <th scope="col">Naziv polja</th>
                                                    <th scope="col">Vrednost</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td style="font-weight:bold;">Ime korisnika</td>
                                                    <td style="text-align:center;">@Model.Tiketi.UserName</td>
                                                </tr>
                                                <tr>
                                                    <td style="font-weight:bold;">Naslov tiketa</td>
                                                    <td style="text-align:center;">@Model.Tiketi.Naslov</td>
                                                </tr>
                                                <tr>
                                                    <td style="font-weight:bold;">Opis</td>
                                                    <td style="text-align:center;">@Html.Raw(@Model.Tiketi.Opis)</td>
                                                </tr>
                                                <tr>
                                                    <td style="font-weight:bold;">Datum izdavanja</td>
                                                    <td style="text-align:center;">@Convert.ToDateTime(Model.Tiketi.Datum).ToString("dd/MM/yyyy HH:mm")</td>
                                                </tr>

                                                <tr>
                                                    <td style="font-weight:bold;">Tiket izdao</td>
                                                    <td style="text-align:center;">@Model.Tiketi.UserName</td>
                                                </tr>

                                                <tr>
                                                    <td style="font-weight:bold;">Naslovljen na</td>
                                                    <td style="text-align:center;">@Model.Tiketi.UserNameAssignedTo</td>
                                                </tr>

                                                <tr>
                                                    <td style="font-weight:bold;">Kategorija</td>
                                                    <td style="text-align:center;">@Model.Tiketi.Kategorija.Naziv</td>
                                                </tr>
                                                <tr>
                                                    <td style="font-weight:bold;">Status</td>
                                                    <td style="text-align:center;">@Model.Tiketi.Status.Naziv</td>
                                                </tr>
                                            </tbody>
                                        </table>


                                        <!--ovde deo za relacije-->
                                        <table class="table table-bordered table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Vezan za</th>
                                                    <th style="text-align:center;">Akcija</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var item in Model.Tiketi.Relations)
                                                {
                                                    <tr>
                                                        <td>@item.RelatedId</td>
                                                        <td style="text-align:center;">
                                                            @Html.ActionLink("Details", "Details", new { id = item.RelatedId }) <i class="fas fa-fw fa-edit"></i> <br />
                                                        </td>
                                                    </tr>

                                                }
                                            </tbody>
                                        </table>

                                        @using (Html.BeginForm("AddRelation", "Tikets", FormMethod.Post, new { enctype = "multipart/form-data" }))
                                        {
                                            @Html.AntiForgeryToken()
                                            <p style="font-size:18px; font-weight:bold;">Broj tiketa za relaciju</p>
                                            <div style="float:left;">
                                                <input class="form-control" id="relatedId" name="relatedId" type="text" />

                                            </div>
                                            <span>&nbsp;&nbsp;&nbsp;&nbsp;</span>
                                            <input type="hidden" id="IDTiketRel" name="IDTiketRel" value="@Model.Tiketi.IDTiket" />

                                            <a class="btn btn-primary btn-icon-split">
                                                <span class="icon text-white-50">
                                                    <i class="fas fa-check"></i>
                                                </span>
                                                <input type="submit" value="Dodaj relaciju" class="btn btn-primary" />
                                            </a>

                                            <a href="@Url.Action("Index", "Tikets")" class="btn btn-secondary btn-icon-split" style="float:right;">
                                                <span class="icon text-white-50">
                                                    <i class="fas fa-fw fa-list"></i>
                                                </span>
                                                <span class="text">Povratak na listu tiketa</span>
                                            </a>
                                        }

                                        <!--ovde deo za relacije-->




                                    </div>

                                    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                                        <br />
                                        <div>
                                            <table class="table table-bordered table-striped" style="table-layout:fixed;">
                                                <thead style="text-align:center; font-size:18px;">
                                                    <tr>
                                                        <th scope="col">Naziv korisnika</th>
                                                        <th scope="col">Komentar</th>
                                                        <th scope="col">Datum</th>
                                                        <th scope="col">Datoteka</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var item in Model.Tiketi.Komentars)
                                                    {
                                                        <tr>
                                                            <td style="font-weight:bold;">@item.UserName:</td>
                                                            <td style="text-align:center;">@Html.Raw(@item.Tekst)</td>
                                                            <td style="text-align:center;">@Convert.ToDateTime(item.Datum).ToString("dd/MM/yyyy HH:mm")</td>
                                                            @if (item.tbl_file.Count > 0)
                                                            {
                                                                <td style="text-align:center;">
                                                                    @foreach (var file in Model.Tiketi.tbl_file)
                                                                    {
                                                                        if (file.IDKomentar == item.IDKomentar)
                                                                        {
                                                                            <a class="download-file1" href="@Url.Action("DownloadFile", "Img", new { fileId = @file.file_id })"
                                                                               target="_blank">
                                                                                @file.file_name
                                                                            </a>
                                                                            <i class="fa-solid fa-grip-lines-vertical"></i>
                                                                        }
                                                                    }
                                                                </td>
                                                            }
                                                            else
                                                            {
                                                                <td style="text-align:center;"> Nema datoteke </td>
                                                            }
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>

                                        </div>

                                        <hr />

                                        @using (Html.BeginForm("Create", "Komentar", FormMethod.Post, new { enctype = "multipart/form-data" }))
                                        {
                                            @Html.AntiForgeryToken()

                                            <div class="form-horizontal">
                                                <h3 style="text-align:center; font-weight:bold;">Ostavi komentar</h3>

                                                <input class="form-control" id="idTekst" name="Tekst" type="text" /> <br />


                                                @*<input class="form-control" id="Model.Tiketi.Komentars.Tekst" name="Tekst" type="text" /> <br />*@

                                                @*<input type="button" id="iddugme" value="Click" />*@
                                                <div style="float:left;">
                                                    <input class="form-control" name="FileAttach" placeholder="Upload File" type="file" multiple>
                                                </div>
                                                @*<input type="submit" value="Ostavi komentar" class="btn btn-default" />*@
                                                <input type="hidden" id="IDTiket" name="IDTiket" value="@Model.Tiketi.IDTiket" />

                                                <a class="btn btn-primary btn-icon-split" style="float:right;">
                                                    <span class="icon text-white-50">
                                                        <i class="fas fa-check"></i>
                                                    </span>
                                                    <input type="submit" value="Ostavi komentar" class="btn btn-primary" />
                                                </a>
                                                <br />
                                            </div>
                                        }

                                    </div>

                                    <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                                        <br />

                                     
                                        <table class="table">

                                           
                                            <tr style="border-style:hidden;">
                                                <td style="width:300px; font-size:18px; font-weight:bold;">Dodavanje dokumenta</td>
                                                <td>
                                                    <input class="form-control" data-val="true" data-val-required="The Upload File field is required."
                                                           id="Model.ImgViewModel.FileAttach" name="FileAttach" placeholder="Upload File" type="file" value="">
                                                </td>
                                                <td style="width:300px;">
                                                    <input type="submit" class="btn btn-danger" value="Upload" style="width:200px;" />
                                                </td>
                                            </tr>



                                        </table>
                                        <br />

                                        <div class="row">
                                            <div class="col-md-offset-4 col-md-12">
                                                <h3 style="text-align:center; font-weight:bold;">Lista dokumenata</h3>
                                            </div>
                                        </div>

                                        <br />  <br />

                                        @if (Model.Files.ImgLst != null &&
                                             Model.Files.ImgLst.Count > 0)
                                        {
                                            <div class="row">
                                                <div class="col-md-offset-1 col-md-12">
                                                    <section>
                                                        <table class="table table-bordered table-striped">
                                                            <thead style="text-align:center; font-size:18px;">
                                                                <tr>
                                                                    <th style="text-align: center;">Rb.</th>
                                                                    <th style="text-align: center;">Naziv dokumenta</th>
                                                                    <th style="text-align: center;">Ime Korisnika</th>
                                                                    <th style="text-align: center;">Datum</th>
                                                                </tr>
                                                            </thead>

                                                            <tbody>
                                                                @for (int i = 0; i < Model.Files.ImgLst.Count; i++)
                                                                {
                                                                    <tr>
                                                                        <td style="text-align: center;">@(i + 1)</td>

                                                                        <td>
                                                                            <div class="input-group" style="height:40px;">
                                                                                <i class="fa fa-2x fa-paperclip text-navy"></i>
                                                                                <a class="download-file1" href="@Url.Action("DownloadFile", "Img", new { fileId = @Model.Files.ImgLst[i].FileId })" target="_blank">
                                                                                    @Model.Files.ImgLst[i].FileName
                                                                                </a>
                                                                            </div>
                                                                        </td>

                                                                        <td style="text-align: center;">
                                                                            <div>
                                                                                <a>@Model.Files.ImgLst[i].UserName</a>

                                                                            </div>
                                                                        </td>


                                                                        <td style="text-align: center;">
                                                                            <div>
                                                                                <a>
                                                                                    @Convert.ToDateTime(@Model.Files.ImgLst[i].Datum).ToString("dd/MM/yyyy HH:mm")
                                                                                </a>
                                                                            </div>
                                                                        </td>


                                                                    </tr>


                                                                }
                                                            </tbody>
                                                        </table>
                                                    </section>
                                                </div>
                                            </div>
                                        }
                                    </div>

                                    <div class="tab-pane fade" id="contact1" role="tabpanel" aria-labelledby="contact1-tab">
                                        @using (Html.BeginForm("EditStatus", "Tikets", FormMethod.Post))
                                        {
                                            @Html.AntiForgeryToken()

                                            <br />
                                            <div class="form-horizontal">

                                                <div class="form-group">
                                                    <p class="control-label col-md-2">Status tiketa</p>
                                                    <div class="col-md-10">
                                                        @Html.DropDownList("IDStatus", (SelectList)ViewBag.IDStatus, "--Izaberite vrednost--", htmlAttributes: new { @class = "form-control" })
                                                        @Html.ValidationMessageFor(model => model.Tiketi.IDStatus, "", new { @class = "text-danger" })
                                                        <input type="hidden" id="id" name="IDTiket" value="@Model.Tiketi.IDTiket" />
                                                    </div>
                                                </div>


                                                <!--proba da se sve izmene stave na jedan tab-->


                                                <div class="form-group">
                                                    <p class="control-label col-md-2">Kategorija tiketa</p>
                                                    <div class="col-md-10">
                                                        @Html.DropDownList("IDKat", (SelectList)ViewBag.IDKat, "--Izaberite vrednost--", htmlAttributes: new { @class = "form-control" })
                                                        @Html.ValidationMessageFor(model => model.Tiketi.IDKat, "", new { @class = "text-danger" })
                                                        <input type="hidden" id="id" name="IDTiket" value="@Model.Tiketi.IDTiket" />
                                                    </div>
                                                </div>


                                                <div class="form-group">
                                                    <p class="control-label col-md-2">Naslovljen na</p>
                                                    <div class="col-md-10">
                                                        @Html.DropDownList("IDUserAssignedTo", (SelectList)ViewBag.IDUserAssignedTo, "--Izaberite vrednost--", htmlAttributes: new { @class = "form-control" })
                                                        <input type="hidden" id="id" name="IDTiket" value="@Model.Tiketi.IDTiket" />
                                                    </div>
                                                </div>

                                                <!--proba da se sve izmene stave na jedan tab-->

                                                <div class="form-group">
                                                    <div class="col-md-offset-2 col-md-10">
                                                        <a class="btn btn-primary btn-icon-split">
                                                            <span class="icon text-white-50">
                                                                <i class="fas fa-check"></i>
                                                            </span>
                                                            <input type="submit" value="Sačuvaj" class="btn btn-primary" />
                                                        </a>


                                                    </div>
                                                </div>

                                            </div>

                                        }
                                    </div>

                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>










